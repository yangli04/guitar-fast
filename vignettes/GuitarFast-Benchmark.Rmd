---
title: "GuitarFast vs Guitar: Performance Benchmark"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GuitarFast vs Guitar: Performance Benchmark}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Summary

GuitarFast is a performance-optimized fork of the Guitar Bioconductor package (v2.26.0). This vignette documents the optimizations and benchmark results.

## Benchmark Results

Measured on the bundled toy dataset (mm10 subset, 1000 m6A peaks). Both packages produce identical density curves for deterministic (no-CI) runs.

| Scenario | Guitar (original) | GuitarFast | Speedup |
|:---------|-------------------:|-----------:|--------:|
| tx, no CI | 8.40s | 1.52s | **5.5x** |
| tx, CI (200 resamples) | 9.37s | 1.56s | **6.0x** |
| mrna, no CI | 4.22s | 1.40s | **3.0x** |
| All types, CI (200 resamples) | 18.77s | 4.79s | **3.9x** |

## Running the Benchmark Yourself

GuitarFast ships with a benchmark script in `tests/test_benchmark.R`:

```{r benchmark}
library(GuitarFast)
library(GenomicFeatures)

txdb <- loadDb(system.file("extdata", "mm10_toy.sqlite", package = "GuitarFast"))
bed1 <- system.file("extdata", "m6A_mm10_exomePeak_1000peaks_bed12.bed",
                     package = "GuitarFast")

bench <- function(label, expr) {
  t1 <- proc.time()
  result <- eval(expr)
  elapsed <- (proc.time() - t1)["elapsed"]
  cat(sprintf("  %-35s %6.2fs\n", label, elapsed))
  invisible(result)
}

cat("== GuitarFast Benchmarks ==\n")

bench("makeGuitarTxdb",
  quote(makeGuitarTxdb(txdb = txdb, txPrimaryOnly = FALSE)))

bench("GuitarPlot tx, no CI",
  quote(GuitarPlot(txTxdb = txdb, stBedFiles = list(bed1),
                   enableCI = FALSE, pltTxType = c("tx"))))

bench("GuitarPlot tx, CI (200 resamp)",
  quote(GuitarPlot(txTxdb = txdb, stBedFiles = list(bed1),
                   enableCI = TRUE, pltTxType = c("tx"))))
```

A side-by-side comparison script (requires the original Guitar package installed alongside GuitarFast) is available at `tests/test_compare.R`.

## Optimizations Applied

### 1. `elementNROWS()` instead of `vapply(NROW)` (800x speedup)

**File**: `R/makeGuitarTxdb.R`

The single largest bottleneck. The original code counted ranges per transcript using:

```r
# Original (6.7 seconds)
vapply(txRange, NROW, numeric(1))
```

This calls R's `NROW` individually on each of ~2700 GRanges elements via an R-level loop. Replaced with:

```r
# Optimized (0.008 seconds)
elementNROWS(txRange)
```

`elementNROWS()` is a single C-level vectorized call in the IRanges package.

### 2. Reduced Default CI Resamples (1000 to 200)

**File**: `R/GuitarPlot.R`

Each bootstrap iteration calls `density()` (C code), so the only way to speed up the CI computation is to reduce the number of iterations. We benchmarked CI quality:

| Resamples | Mean CI Range | Max CI Range |
|----------:|--------------:|-------------:|
| 200 | 0.259 | 0.852 |
| 500 | 0.262 | 0.861 |
| 1000 | 0.264 | 0.866 |

200 resamples produce statistically equivalent confidence intervals. Users who want the original behavior can set `CI_ResamplingTime = 1000`.

### 3. Pre-allocated Resampling Matrix

**File**: `R/GuitarPlot.R`

The original used `replicate()` which allocates memory on each iteration. GuitarFast pre-allocates the full result matrix and generates all random group indices in one batch call:

```r
# Pre-allocate 256 x N matrix
fit2 <- matrix(0, nrow = 256L, ncol = CI_ResamplingTime)

# Generate all resampling indices at once
resample_idx_mat <- matrix(
  sample.int(nGroups, nGroups * CI_ResamplingTime, replace = TRUE),
  nrow = nGroups, ncol = CI_ResamplingTime
)
```

### 4. C-optimized Quantile Computation

**File**: `R/GuitarPlot.R`

Replaced R-level `apply(fit2, 1, quantile, ...)` with C-optimized `matrixStats::rowQuantiles()`:

```r
if (requireNamespace("matrixStats", quietly = TRUE)) {
  fit3 <- matrixStats::rowQuantiles(fit2, probs = CI_interval)
} else {
  fit3 <- t(apply(fit2, 1, quantile, CI_interval))
}
```

Falls back gracefully when matrixStats is not installed.

### 5. Vectorized `normalize()`

**File**: `R/siteNormalize.R`

Two R-level per-row loops replaced with vectorized operations:

```r
# Original: apply() per row
sitesPointsComponet <- apply(startPointDiffer, 1, max_which)

# Optimized: vectorized max.col
neg_mask <- startPointDiffer < 0
col_idx_mat <- col(startPointDiffer) * neg_mask
sitesPointsComponet <- max.col(col_idx_mat, ties.method = "last")
```

```r
# Original: unlist(lapply(...)) per element
sitesPointsComponet_pct <- unlist(lapply(1:length(...), component_which, ...))

# Optimized: cbind matrix indexing
sitesPointsComponet_pct <- sitesComponet_pct[
  cbind(seq_along(sitesPointsComponet), sitesPointsComponet)
]
```

### 6. Fixed Growing GRanges (O(n^2) to O(n))

**File**: `R/makeGuitarTxdb.R`

The original appended GRanges in a loop, causing quadratic memory copies:

```r
# Original: O(n^2) - copies entire object each iteration
for (...) {
  txComponentGRange <- c(txComponentGRange, temp_gr)
}

# Optimized: O(n) - list accumulation, single concatenation
gr_list <- vector("list", expected_length)
for (...) {
  gr_list[[k]] <- temp_gr
}
txComponentGRange <- do.call(c, gr_list)
```

### 7. Bug Fixes

- **Duplicate rectangle annotations**: Lines 96-101 of the original `GuitarPlot.R` were an exact copy of lines 89-94, drawing every transcript component rectangle twice. Removed the duplicate.

- **GuitarTxdb save/load broken**: The original `save()` function correctly wrote binary RData, but `load` used `read.table()` to read it back. Fixed to use `load()` with an isolated environment.

## Numerical Verification

For deterministic runs (no CI), GuitarFast produces **bit-identical** density curves:

```
Max |y_original - y_optimized| = 0.00e+00
```

For CI runs, the curves are statistically equivalent within bootstrap variance. The CI bounds differ only due to random resampling, not due to algorithmic changes.

## API Compatibility

GuitarFast maintains full API compatibility with Guitar v2.26.0. The only default change:

| Parameter | Guitar | GuitarFast |
|:----------|:-------|:-----------|
| `CI_ResamplingTime` | 1000 | 200 |

All other function signatures, parameter names, and return types are identical.

## Session Info

```{r session}
sessionInfo()
```
